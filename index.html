
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>배드민턴 코트 배정</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f8ff; padding: 1em; }
    h2 { text-align: center; }
    textarea { width: 100%; height: 100px; font-size: 16px; margin-bottom: 1em; }
    .btn { width: 100%; padding: 12px; background-color: #007bff; color: white; font-size: 16px; border: none; border-radius: 8px; margin-bottom: 20px; cursor: pointer; }
    .layout { display: flex; flex-direction: row; flex-wrap: nowrap; overflow-x: auto; gap: 10px; justify-content: space-between; }
    .column { background: white; border: 2px solid #ccc; border-radius: 8px; padding: 10px; flex: 1 0 auto; min-width: 200px; min-height: 150px; position: relative; }
    .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: nowrap; gap: 10px; margin-bottom: 5px; }
    .header h4 { margin: 0; white-space: nowrap; font-size: 24px; }
    .reset-btn { background: #ff6666; color: white; border: none; padding: 4px 8px; border-radius: 5px; font-size: 14px; cursor: pointer; }
    .name-tag { font-size: 14px; font-weight: bold; padding: 8px 10px; line-height: 24px; min-height: 32px; display: inline-block; margin: 5px; border: 2px solid #444; border-radius: 6px; background: #ffffcc; position: relative; }
    .male { background-color: #cce5ff; border-color: #3399ff; }
    .female { background-color: #ffd6e8; border-color: #ff66b2; }
    .badge { position: absolute; top: -0.5em; left: -0.5em; background: #800020; color: white; font-size: 0.8em; width: 1.5em; height: 1.5em; line-height: 1.5em; border-radius: 50%; text-align: center; z-index: 10; cursor: pointer; }
    .sort-btns { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .namepool-row { display: flex; justify-content: center; margin-top: 20px; }
    #namePool { width: 95%; }
  </style>
</head>
<body>
<h2>배드민턴 코트 배정</h2>
<textarea id="inputArea" placeholder="이름 급수 성별 입력"></textarea>
<button class="btn" id="generateBtn">이름표 만들기</button>

<div class="layout" id="layout">
  <div class="column" id="wait1"><div class="header"><h4>대기 1</h4><button class="reset-btn" onclick="resetColumn('wait1')">리셋</button></div><div class="sort-btns">
    <button class="reset-btn" onclick="moveAll('wait1','court1')">1코트</button>
    <button class="reset-btn" onclick="moveAll('wait1','court2')">2코트</button>
    <button class="reset-btn" onclick="moveAll('wait1','court3')">3코트</button>
    <button class="reset-btn" onclick="moveAll('wait1','court4')">4코트</button>
  </div></div>
  <div class="column" id="wait2"><div class="header"><h4>대기 2</h4><button class="reset-btn" onclick="resetColumn('wait2')">리셋</button></div><div class="sort-btns">
    <button class="reset-btn" onclick="moveAll('wait2','wait1')">대기1</button>
    <button class="reset-btn" onclick="moveAll('wait2','court1')">1코트</button>
    <button class="reset-btn" onclick="moveAll('wait2','court2')">2코트</button>
    <button class="reset-btn" onclick="moveAll('wait2','court3')">3코트</button>
    <button class="reset-btn" onclick="moveAll('wait2','court4')">4코트</button>
  </div></div>
  <div class="column" id="court1"><div class="header"><h4>1코트</h4><button class="reset-btn" onclick="resetColumn('court1')">리셋</button><button class="reset-btn" onclick="endCourt('court1')">종료</button></div></div>
  <div class="column" id="court2"><div class="header"><h4>2코트</h4><button class="reset-btn" onclick="resetColumn('court2')">리셋</button><button class="reset-btn" onclick="endCourt('court2')">종료</button></div></div>
  <div class="column" id="court3"><div class="header"><h4>3코트</h4><button class="reset-btn" onclick="resetColumn('court3')">리셋</button><button class="reset-btn" onclick="endCourt('court3')">종료</button></div></div>
  <div class="column" id="court4"><div class="header"><h4>4코트</h4><button class="reset-btn" onclick="resetColumn('court4')">리셋</button><button class="reset-btn" onclick="endCourt('court4')">종료</button></div></div>
</div>

<div class="namepool-row">
  <div class="column" id="namePool">
    <div class="header"><h4>대기</h4></div>
    <div class="sort-btns">
      <button class="reset-btn" onclick="resetAll()">초기화</button>
      <button class="reset-btn" onclick="sortNamePool('급수정렬')">급수정렬</button>
      <button class="reset-btn" onclick="sortNamePool('횟수정렬')">횟수정렬</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0caXzAibBt9caNKOnEwEzq3kEtKgABdw",
    authDomain: "cock-9ca00.firebaseapp.com",
    databaseURL: "https://cock-9ca00-default-rtdb.firebaseio.com",
    projectId: "cock-9ca00",
    storageBucket: "cock-9ca00.firebasestorage.app",
    messagingSenderId: "1097422224517",
    appId: "1:1097422224517:web:e103a3b4d57896fd627dec",
    measurementId: "G-T5RMLR8QK5"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const ids = ["wait1", "wait2", "court1", "court2", "court3", "court4", "namePool"];

  function createTag(key, data) {
    const tag = document.createElement("div");
    tag.className = "name-tag";
    tag.dataset.key = key;
    tag.textContent = data.name + " " + data.level;
    tag.classList.add(data.gender === "남" ? "male" : "female");

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = data.badge || "0";
    badge.ondblclick = () => {
      const input = document.createElement("input");
      input.type = "number";
      input.value = badge.textContent;
      badge.textContent = "";
      badge.appendChild(input);
      input.focus();
      input.onblur = () => {
        badge.textContent = isNaN(parseInt(input.value)) ? "0" : input.value;
        syncState();
      };
    };
    tag.appendChild(badge);
    return tag;
  }

  function syncState() {
    const state = {};
    ids.forEach(id => {
      const tags = Array.from(document.getElementById(id).querySelectorAll(".name-tag")).map(tag => ({
        name: tag.textContent.trim().split(" ")[0],
        level: tag.textContent.trim().split(" ")[1],
        gender: tag.classList.contains("male") ? "남" : "여",
        badge: tag.querySelector(".badge")?.textContent || "0"
      }));
      state[id] = tags;
    });
    set(ref(db, "court-state"), state);
  }

  function applyState(state) {
    ids.forEach(id => {
      const container = document.getElementById(id);
      container.querySelectorAll(".name-tag").forEach(e => e.remove());
      state[id]?.forEach(data => {
        const tag = createTag(data.name + Date.now(), data);
        container.appendChild(tag);
      });
    });
  }

  onValue(ref(db, "court-state"), snapshot => {
    const state = snapshot.val();
    if (state) applyState(state);
  });

  window.generateTags = function () {
    const input = document.getElementById("inputArea").value.trim();
    const lines = input.split("\n");
    lines.forEach(line => {
      const [name, level, gender] = line.trim().split(" ");
      const tag = createTag(name + Date.now(), { name, level, gender });
      document.getElementById("namePool").appendChild(tag);
    });
    document.getElementById("inputArea").value = "";
    syncState();
  };

  document.getElementById("generateBtn").onclick = generateTags;

  window.moveAll = function (fromId, toId) {
    const from = document.getElementById(fromId);
    const to = document.getElementById(toId);
    from.querySelectorAll('.name-tag').forEach(tag => to.appendChild(tag));
    syncState();
  };

  window.resetColumn = function (id) {
    const col = document.getElementById(id);
    const pool = document.getElementById("namePool");
    col.querySelectorAll(".name-tag").forEach(tag => pool.appendChild(tag));
    syncState();
  };

  window.resetAll = function () {
    ids.forEach(id => {
      const col = document.getElementById(id);
      col.querySelectorAll(".name-tag").forEach(tag => tag.remove());
    });
    syncState();
  };

  window.endCourt = function (id) {
    const col = document.getElementById(id);
    col.querySelectorAll(".name-tag").forEach(tag => {
      const badge = tag.querySelector(".badge");
      badge.textContent = (parseInt(badge.textContent) || 0) + 1;
      document.getElementById("namePool").appendChild(tag);
    });
    syncState();
  };

  window.sortNamePool = function (type) {
    const pool = document.getElementById("namePool");
    const tags = Array.from(pool.querySelectorAll(".name-tag"));
    tags.sort((a, b) => {
      if (type === "급수정렬") {
        const order = { "S": 0, "A": 1, "B": 2, "C": 3, "D": 4 };
        const aLevel = a.textContent.trim().split(" ")[1]?.charAt(0) || "";
        const bLevel = b.textContent.trim().split(" ")[1]?.charAt(0) || "";
        return (order[aLevel] ?? 99) - (order[bLevel] ?? 99);
      }
      if (type === "횟수정렬") {
        return parseInt(a.querySelector(".badge")?.textContent || 0) - parseInt(b.querySelector(".badge")?.textContent || 0);
      }
      return 0;
    });
    tags.forEach(tag => pool.appendChild(tag));
    syncState();
  };
</script>
</body>
</html>
