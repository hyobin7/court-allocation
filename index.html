<!DOCTYPE html>

<html lang="ko"><head><meta charset="utf-8"/><title>배드민턴 코트 배정</title><script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script><meta content="width=device-width, initial-scale=1" name="viewport"/></head><body><script>
const firebaseConfig = {
  apiKey: "AIzaSyBQnSbBwJR-IS1aOuNrJz4qopK3RSiZbGY",
  authDomain: "cock-5c32d.firebaseapp.com",
  databaseURL: "https://cock-5c32d-default-rtdb.firebaseio.com",
  projectId: "cock-5c32d",
  storageBucket: "cock-5c32d.appspot.com",
  messagingSenderId: "639370966543",
  appId: "1:639370966543:web:84bdc6f474a7ba8cbc557a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let tagRefs = {};

function createTag(key, data) {
  if (tagRefs[key]) return;
  const tag = document.createElement("div");
  tag.className = "name-tag";
  tag.dataset.key = key;
  tag.textContent = data.name + " " + data.level;
  tag.classList.add(data.gender === "남" ? "male" : "female");

  tag.addEventListener("contextmenu", e => {
    e.preventDefault();
    if (confirm("이 이름표를 삭제할까요?")) {
      db.ref("nameTags/" + key).remove();
    }
  });

  tag.addEventListener("touchend", function(e) {
    if (!tag.dataset.lastTouch || Date.now() - tag.dataset.lastTouch > 400) {
      tag.dataset.lastTouch = Date.now();
    } else {
      db.ref("nameTags/" + key).remove();
      tag.dataset.lastTouch = 0;
    }
  });

  // badge
  const badge = document.createElement("span");
  badge.className = "badge";
  badge.textContent = "0";
  badge.ondblclick = function () {
    const input = document.createElement("input");
    input.type = "number";
    input.value = badge.textContent;
    badge.innerHTML = "";
    badge.appendChild(input);
    input.focus();
    input.onblur = () => badge.textContent = input.value || '0';
    input.onkeydown = (e) => { if (e.key === "Enter") input.blur(); };
  };
  tag.insertBefore(badge, tag.firstChild);

  tagRefs[key] = tag;
  return tag;
}

function generateTags() {
  const input = document.getElementById("inputArea").value.trim();
  const lines = input.split("\n");
  lines.forEach(line => {
    const parts = line.trim().split(" ");
    if (parts.length >= 3) {
      const name = parts[0];
      const level = parts[1];
      const gender = parts[2];
      db.ref("nameTags").push({ name, level, gender, court: "namePool" });
    }
  });
  document.getElementById("inputArea").value = "";
}

function resetToWait(waitId) {
  Object.entries(tagRefs).forEach(([key, el]) => {
    if (el.parentElement.id === waitId) {
      db.ref("nameTags/" + key).update({ court: "namePool" });
    }
  });
}

function resetCourt(courtId) {
  Object.entries(tagRefs).forEach(([key, el]) => {
    if (el.parentElement.id === courtId) {
      db.ref("nameTags/" + key).update({ court: "namePool" });
    }
  });
}

function moveAllToCourt(fromId, toId) {
  const fromEl = document.getElementById(fromId);
  const toEl = document.getElementById(toId);
  const tags = fromEl.querySelectorAll('.name-tag');
  let count = toEl.querySelectorAll('.name-tag').length;
  tags.forEach(tag => {
    if (["court1", "court2", "court3"].includes(toId)) {
      if (count < 4) {
        db.ref("nameTags/" + tag.dataset.key).update({ court: toId });
        count++;
      }
    } else {
      db.ref("nameTags/" + tag.dataset.key).update({ court: toId });
    }
  });
}

function endCourt(courtId) {
  const court = document.getElementById(courtId);
  const namePool = document.getElementById("namePool");
  const tags = court.querySelectorAll('.name-tag');
  tags.forEach(tag => {
    namePool.appendChild(tag);
    const badge = tag.querySelector('.badge');
    badge.textContent = parseInt(badge.textContent || "0") + 1;
    db.ref("nameTags/" + tag.dataset.key).update({ court: "namePool" });
  });
}

function sortByLevel() {
  const pool = document.getElementById("namePool");
  const tags = [...pool.querySelectorAll(".name-tag")];
  tags.sort((a, b) => a.textContent.split(" ")[1].localeCompare(b.textContent.split(" ")[1]));
  tags.forEach(t => pool.appendChild(t));
}

function sortByCount() {
  const pool = document.getElementById("namePool");
  const tags = [...pool.querySelectorAll(".name-tag")];
  tags.sort((a, b) => {
    const aCount = parseInt(a.querySelector('.badge')?.textContent || 0);
    const bCount = parseInt(b.querySelector('.badge')?.textContent || 0);
    return bCount - aCount;
  });
  tags.forEach(t => pool.appendChild(t));
}

["namePool", "wait1", "wait2", "court1", "court2", "court3"].forEach(id => {
  new Sortable(document.getElementById(id), {
    group: "shared",
    animation: 150,
    onAdd: evt => {
      const key = evt.item.dataset.key;
      const court = evt.to.id;
      if (["court1", "court2", "court3"].includes(court) &&
          evt.to.querySelectorAll('.name-tag').length > 4) {
        evt.from.appendChild(evt.item);
        alert("각 칸에는 최대 4명까지만 배정할 수 있습니다.");
        return;
      }
      db.ref("nameTags/" + key).update({ court });
    }
  });
});

db.ref("nameTags").on("child_added", snap => {
  const key = snap.key;
  const data = snap.val();
  if (tagRefs[key]) return;
  const tag = createTag(key, data);
  if (tag) document.getElementById(data.court || "namePool").appendChild(tag);
});
db.ref("nameTags").on("child_removed", snap => {
  const tag = tagRefs[snap.key];
  if (tag) tag.remove();
  delete tagRefs[snap.key];
});
db.ref("nameTags").on("child_changed", snap => {
  const tag = tagRefs[snap.key];
  const data = snap.val();
  if (tag) document.getElementById(data.court || "namePool").appendChild(tag);
});

window.onload = () => {
  document.getElementById("generateBtn").onclick = generateTags;
  document.getElementById("inputArea").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      generateTags();
    }
  });
};
</script></body></html>